async function adminApi(path, opts={}){ const token = sessionStorage.getItem('tc_admin_token'); const headers = opts.headers||{}; if(token) headers['X-Admin-Token']=token; const res = await fetch(path, Object.assign({}, opts, { headers })); if(res.status===401) document.getElementById('status').textContent='Unauthorized'; return res.json().catch(()=>({ ok:false })); }
function renderRow(r){ return `<tr><td>${r.to_email}</td><td>${r.subject}</td><td>${r.status}</td><td>${r.attempts}</td><td>${r.last_error||''}</td><td>${new Date(r.ts_created).toLocaleString()}</td><td><button class="retry" data-id="${r.id}">Retry</button></td></tr>` }
async function load(){ const data = await adminApi('/admin/api/email-queue'); const tbody=document.querySelector('#queue tbody'); tbody.innerHTML=''; if(!Array.isArray(data)) return; data.forEach(d=>{ tbody.insertAdjacentHTML('beforeend', renderRow(d)); }); document.querySelectorAll('button.retry').forEach(b=>b.addEventListener('click', async (ev)=>{ const id=ev.target.dataset.id; const res=await adminApi(`/admin/api/email-queue/${id}/retry`, { method:'POST' }); document.getElementById('status').textContent=JSON.stringify(res); load(); })); }
document.getElementById('save-token').addEventListener('click', ()=>{ const t=document.getElementById('admin-token').value.trim(); if(!t) return; sessionStorage.setItem('tc_admin_token', t); document.getElementById('status').textContent='Token saved'; load(); });
document.getElementById('refresh').addEventListener('click', load);
document.getElementById('process').addEventListener('click', async ()=>{ const res=await adminApi('/admin/api/email-queue/process', { method:'POST' }); document.getElementById('status').textContent=JSON.stringify(res); load(); });
if(sessionStorage.getItem('tc_admin_token')){ load(); }